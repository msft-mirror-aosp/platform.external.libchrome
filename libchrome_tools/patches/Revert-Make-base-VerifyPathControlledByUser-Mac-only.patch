From 1ed5f5cb236d1800da9b7dd3061d65d3800c68c4 Mon Sep 17 00:00:00 2001
From: Grace Cham <hscham@chromium.org>
Date: Wed, 11 May 2022 13:44:41 +0900
Subject: [PATCH] Revert "Make base::VerifyPathControlledByUser() Mac-only."

This reverts commit 9b16796d1ebbb68f7dc1f8adf2128fc4b00f4a61.
---
 base/files/file_util.h           |  4 ++--
 base/files/file_util_posix.cc    |  4 +---
 base/files/file_util_unittest.cc | 12 ++++++------
 3 files changed, 9 insertions(+), 11 deletions(-)

diff --git a/base/files/file_util.h b/base/files/file_util.h
index df747d66f3..5ce0e538b3 100644
--- a/base/files/file_util.h
+++ b/base/files/file_util.h
@@ -578,9 +578,7 @@ BASE_EXPORT bool CreateLocalNonBlockingPipe(int fds[2]);
 // Returns true if it was able to set it in the close-on-exec mode, otherwise
 // false.
 BASE_EXPORT bool SetCloseOnExec(int fd);
-#endif  // BUILDFLAG(IS_POSIX) || BUILDFLAG(IS_FUCHSIA)
 
-#if BUILDFLAG(IS_MAC)
 // Test that |path| can only be changed by a given user and members of
 // a given set of groups.
 // Specifically, test that all parts of |path| under (and including) |base|:
@@ -596,7 +594,9 @@ BASE_EXPORT bool VerifyPathControlledByUser(const base::FilePath& base,
                                             const base::FilePath& path,
                                             uid_t owner_uid,
                                             const std::set<gid_t>& group_gids);
+#endif  // BUILDFLAG(IS_POSIX) || BUILDFLAG(IS_FUCHSIA)
 
+#if BUILDFLAG(IS_MAC)
 // Is |path| writable only by a user with administrator privileges?
 // This function uses Mac OS conventions.  The super user is assumed to have
 // uid 0, and the administrator group is assumed to be named "admin".
diff --git a/base/files/file_util_posix.cc b/base/files/file_util_posix.cc
index 08a1fc0ea2..88cac8990c 100644
--- a/base/files/file_util_posix.cc
+++ b/base/files/file_util_posix.cc
@@ -78,7 +78,6 @@ namespace base {
 
 namespace {
 
-#if BUILDFLAG(IS_MAC)
 // Helper for VerifyPathControlledByUser.
 bool VerifySpecificPathControlledByUser(const FilePath& path,
                                         uid_t owner_uid,
@@ -114,7 +113,6 @@ bool VerifySpecificPathControlledByUser(const FilePath& path,
 
   return true;
 }
-#endif
 
 base::FilePath GetTempTemplate() {
   return FormatTemporaryFileName("XXXXXX");
@@ -1020,7 +1018,6 @@ bool SetCurrentDirectory(const FilePath& path) {
   return chdir(path.value().c_str()) == 0;
 }
 
-#if BUILDFLAG(IS_MAC)
 bool VerifyPathControlledByUser(const FilePath& base,
                                 const FilePath& path,
                                 uid_t owner_uid,
@@ -1056,6 +1053,7 @@ bool VerifyPathControlledByUser(const FilePath& base,
   return true;
 }
 
+#if BUILDFLAG(IS_MAC)
 bool VerifyPathControlledByAdmin(const FilePath& path) {
   const unsigned kRootUid = 0;
   const FilePath kFileSystemRoot("/");
diff --git a/base/files/file_util_unittest.cc b/base/files/file_util_unittest.cc
index c66e348e74..a57f38d4be 100644
--- a/base/files/file_util_unittest.cc
+++ b/base/files/file_util_unittest.cc
@@ -214,7 +214,9 @@ class ReparsePoint {
 
 #endif
 
-#if BUILDFLAG(IS_MAC)
+// Fuchsia doesn't support file permissions.
+#if !BUILDFLAG(IS_FUCHSIA)
+#if BUILDFLAG(IS_POSIX)
 // Provide a simple way to change the permissions bits on |path| in tests.
 // ASSERT failures will return, but not stop the test.  Caller should wrap
 // calls to this function in ASSERT_NO_FATAL_FAILURE().
@@ -230,10 +232,8 @@ void ChangePosixFilePermissions(const FilePath& path,
   mode &= ~mode_bits_to_clear;
   ASSERT_TRUE(SetPosixFilePermissions(path, mode));
 }
-#endif  // BUILDFLAG(IS_MAC)
+#endif  // BUILDFLAG(IS_POSIX)
 
-// Fuchsia doesn't support file permissions.
-#if !BUILDFLAG(IS_FUCHSIA)
 // Sets the source file to read-only.
 void SetReadOnly(const FilePath& path, bool read_only) {
 #if BUILDFLAG(IS_WIN)
@@ -3760,7 +3760,7 @@ TEST_F(FileUtilTest, SetCloseOnExec) {
 
 #endif
 
-#if BUILDFLAG(IS_MAC)
+#if BUILDFLAG(IS_POSIX)
 
 // Testing VerifyPathControlledByAdmin() is hard, because there is no
 // way a test can make a file owned by root, or change file paths
@@ -4044,7 +4044,7 @@ TEST_F(VerifyPathControlledByUserTest, WriteBitChecks) {
   EXPECT_TRUE(VerifyPathControlledByUser(sub_dir_, text_file_, uid_, ok_gids_));
 }
 
-#endif  // BUILDFLAG(IS_MAC)
+#endif  // BUILDFLAG(IS_POSIX)
 
 // Flaky test: crbug/1054637
 #if BUILDFLAG(IS_ANDROID)
-- 
2.36.0.512.ge40c2bad7a-goog

