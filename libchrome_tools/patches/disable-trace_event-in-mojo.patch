From c82f973fd3c00d3bb34abe8e19bfa9b6a5cda25f Mon Sep 17 00:00:00 2001
From: hscham <hscham@chromium.org>
Date: Thu, 21 Oct 2021 11:47:10 +0900
Subject: [PATCH 3/5] Include base_tracing.h instead of real headers

Change-Id: I6a74881ed4b7a0a61b82174e8ad951a029395569
---
 mojo/core/channel.cc                                       | 2 +-
 mojo/core/core.cc                                          | 2 +-
 mojo/core/data_pipe_consumer_dispatcher.cc                 | 2 +-
 mojo/core/data_pipe_producer_dispatcher.cc                 | 2 +-
 mojo/core/handle_table.cc                                  | 4 +++-
 mojo/core/handle_table.h                                   | 2 +-
 mojo/core/message_pipe_dispatcher.cc                       | 3 +--
 mojo/core/user_message_impl.cc                             | 5 +----
 .../memory_allocator_dump_cross_process_uid_mojom_traits.h | 2 +-
 mojo/public/cpp/bindings/lib/connector.cc                  | 6 +++---
 mojo/public/cpp/bindings/lib/message.cc                    | 5 +----
 mojo/public/cpp/bindings/lib/send_message_helper.cc        | 4 +++-
 mojo/public/cpp/bindings/struct_ptr.h                      | 1 -
 mojo/public/cpp/bindings/tracing_helpers.h                 | 2 +-
 mojo/public/cpp/system/simple_watcher.cc                   | 7 ++++---
 .../generators/cpp_templates/module-shared.cc.tmpl         | 2 +-
 .../bindings/generators/cpp_templates/module-shared.h.tmpl | 2 +-
 .../tools/bindings/generators/cpp_templates/module.cc.tmpl | 4 +---
 .../tools/bindings/generators/cpp_templates/module.h.tmpl  | 2 +-
 .../generators/cpp_templates/wrapper_class_definition.tmpl | 2 ++
 20 files changed, 29 insertions(+), 32 deletions(-)

diff --git a/mojo/core/channel.cc b/mojo/core/channel.cc
index ea21b2969a9c..36a586ed2fb2 100644
--- a/mojo/core/channel.cc
+++ b/mojo/core/channel.cc
@@ -17,7 +17,7 @@
 #include "base/memory/raw_ptr.h"
 #include "base/numerics/safe_math.h"
 #include "base/process/process_handle.h"
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 #include "build/build_config.h"
 #include "mojo/core/configuration.h"
 #include "mojo/core/core.h"
diff --git a/mojo/core/core.cc b/mojo/core/core.cc
index 8390a2d9a261..fe54be1940b2 100644
--- a/mojo/core/core.cc
+++ b/mojo/core/core.cc
@@ -21,7 +21,7 @@
 #include "base/strings/string_piece.h"
 #include "base/threading/thread_task_runner_handle.h"
 #include "base/time/time.h"
-#include "base/trace_event/memory_dump_manager.h"
+#include "base/trace_event/base_tracing.h"
 #include "build/build_config.h"
 #include "mojo/core/channel.h"
 #include "mojo/core/configuration.h"
diff --git a/mojo/core/data_pipe_consumer_dispatcher.cc b/mojo/core/data_pipe_consumer_dispatcher.cc
index 4e76209bb5d6..ae5c58d1cbe8 100644
--- a/mojo/core/data_pipe_consumer_dispatcher.cc
+++ b/mojo/core/data_pipe_consumer_dispatcher.cc
@@ -14,7 +14,7 @@
 #include "base/bind.h"
 #include "base/logging.h"
 #include "base/memory/ref_counted.h"
-#include "base/trace_event/trace_event.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/core/core.h"
 #include "mojo/core/data_pipe_control_message.h"
 #include "mojo/core/node_controller.h"
diff --git a/mojo/core/data_pipe_producer_dispatcher.cc b/mojo/core/data_pipe_producer_dispatcher.cc
index 65f72611eec4..db3d6ffbc8ab 100644
--- a/mojo/core/data_pipe_producer_dispatcher.cc
+++ b/mojo/core/data_pipe_producer_dispatcher.cc
@@ -12,7 +12,7 @@
 #include "base/bind.h"
 #include "base/logging.h"
 #include "base/memory/ref_counted.h"
-#include "base/trace_event/trace_event.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/core/configuration.h"
 #include "mojo/core/core.h"
 #include "mojo/core/data_pipe_control_message.h"
diff --git a/mojo/core/handle_table.cc b/mojo/core/handle_table.cc
index 9426281d73f0..b4e1920a2126 100644
--- a/mojo/core/handle_table.cc
+++ b/mojo/core/handle_table.cc
@@ -7,8 +7,10 @@
 #include <stdint.h>
 
 #include <limits>
+#include <map>
 
-#include "base/trace_event/memory_dump_manager.h"
+#include "base/notreached.h"
+#include "base/trace_event/base_tracing.h"
 
 namespace mojo {
 namespace core {
diff --git a/mojo/core/handle_table.h b/mojo/core/handle_table.h
index 0664ea500bf8..7031bd232a6e 100644
--- a/mojo/core/handle_table.h
+++ b/mojo/core/handle_table.h
@@ -12,7 +12,7 @@
 
 #include "base/gtest_prod_util.h"
 #include "base/synchronization/lock.h"
-#include "base/trace_event/memory_dump_provider.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/core/dispatcher.h"
 #include "mojo/core/system_impl_export.h"
 #include "mojo/public/c/system/types.h"
diff --git a/mojo/core/message_pipe_dispatcher.cc b/mojo/core/message_pipe_dispatcher.cc
index ad0a0bbf4936..0a2404b6020f 100644
--- a/mojo/core/message_pipe_dispatcher.cc
+++ b/mojo/core/message_pipe_dispatcher.cc
@@ -9,8 +9,7 @@
 
 #include "base/logging.h"
 #include "base/memory/ref_counted.h"
-#include "base/trace_event/trace_event.h"
-#include "base/trace_event/trace_event_stub.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/core/core.h"
 #include "mojo/core/node_controller.h"
 #include "mojo/core/ports/event.h"
diff --git a/mojo/core/user_message_impl.cc b/mojo/core/user_message_impl.cc
index 927b19fab658..9347a8243512 100644
--- a/mojo/core/user_message_impl.cc
+++ b/mojo/core/user_message_impl.cc
@@ -13,10 +13,7 @@
 #include "base/no_destructor.h"
 #include "base/numerics/safe_conversions.h"
 #include "base/numerics/safe_math.h"
-#include "base/trace_event/memory_allocator_dump.h"
-#include "base/trace_event/memory_dump_manager.h"
-#include "base/trace_event/memory_dump_provider.h"
-#include "base/trace_event/trace_event.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/core/configuration.h"
 #include "mojo/core/core.h"
 #include "mojo/core/node_channel.h"
diff --git a/mojo/public/cpp/base/memory_allocator_dump_cross_process_uid_mojom_traits.h b/mojo/public/cpp/base/memory_allocator_dump_cross_process_uid_mojom_traits.h
index e2ee25b22dee..e1296e45fb27 100644
--- a/mojo/public/cpp/base/memory_allocator_dump_cross_process_uid_mojom_traits.h
+++ b/mojo/public/cpp/base/memory_allocator_dump_cross_process_uid_mojom_traits.h
@@ -6,7 +6,7 @@
 #define MOJO_PUBLIC_CPP_BASE_MEMORY_ALLOCATOR_DUMP_CROSS_PROCESS_UID_MOJOM_TRAITS_H_
 
 #include "base/component_export.h"
-#include "base/trace_event/memory_allocator_dump_guid.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/mojom/base/memory_allocator_dump_cross_process_uid.mojom-shared.h"
 
 namespace mojo {
diff --git a/mojo/public/cpp/bindings/lib/connector.cc b/mojo/public/cpp/bindings/lib/connector.cc
index 27f1db4e468e..5385870b8ede 100644
--- a/mojo/public/cpp/bindings/lib/connector.cc
+++ b/mojo/public/cpp/bindings/lib/connector.cc
@@ -22,9 +22,7 @@
 #include "base/synchronization/lock.h"
 #include "base/task/current_thread.h"
 #include "base/threading/sequence_local_storage_slot.h"
-#include "base/trace_event/trace_event.h"
-#include "base/trace_event/typed_macros.h"
-#include "base/trace_event/trace_event_stub.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/c/system/quota.h"
 #include "mojo/public/cpp/bindings/features.h"
 #include "mojo/public/cpp/bindings/lib/may_auto_lock.h"
@@ -33,7 +31,9 @@
 #include "mojo/public/cpp/bindings/sync_handle_watcher.h"
 #include "mojo/public/cpp/bindings/tracing_helpers.h"
 #include "mojo/public/cpp/system/wait.h"
+#if defined(ENABLE_BASE_TRACING)
 #include "third_party/perfetto/protos/perfetto/trace/track_event/chrome_mojo_event_info.pbzero.h"
+#endif
 
 #if defined(ENABLE_IPC_FUZZER)
 #include "mojo/public/cpp/bindings/message_dumper.h"
diff --git a/mojo/public/cpp/bindings/lib/message.cc b/mojo/public/cpp/bindings/lib/message.cc
index 51a7c5763e7b..bb89e340f034 100644
--- a/mojo/public/cpp/bindings/lib/message.cc
+++ b/mojo/public/cpp/bindings/lib/message.cc
@@ -19,10 +19,7 @@
 #include "base/memory/ptr_util.h"
 #include "base/numerics/safe_math.h"
 #include "base/threading/sequence_local_storage_slot.h"
-#include "base/trace_event/trace_event.h"
-#include "base/trace_event/trace_event_stub.h"
-#include "base/trace_event/trace_id_helper.h"
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/cpp/bindings/associated_group_controller.h"
 #include "mojo/public/cpp/bindings/lib/array_internal.h"
 #include "mojo/public/cpp/bindings/lib/message_fragment.h"
diff --git a/mojo/public/cpp/bindings/lib/send_message_helper.cc b/mojo/public/cpp/bindings/lib/send_message_helper.cc
index 13e1be40e572..503f8d346600 100644
--- a/mojo/public/cpp/bindings/lib/send_message_helper.cc
+++ b/mojo/public/cpp/bindings/lib/send_message_helper.cc
@@ -7,13 +7,14 @@
 #include <cstring>
 #include <tuple>
 
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 
 namespace mojo {
 namespace internal {
 
 void SendMessage(MessageReceiver& receiver, Message& message) {
   uint64_t flow_id = message.GetTraceId();
+  std::ignore = flow_id;
   bool is_sync_non_response = message.has_flag(Message::kFlagIsSync) &&
                               !message.has_flag(Message::kFlagIsResponse);
   TRACE_EVENT_INSTANT("toplevel.flow", "Send mojo message",
@@ -33,6 +34,7 @@ void SendMessage(MessageReceiverWithResponder& receiver,
                  Message& message,
                  std::unique_ptr<MessageReceiver> responder) {
   uint64_t flow_id = message.GetTraceId();
+  std::ignore = flow_id;
   bool is_sync_non_response = message.has_flag(Message::kFlagIsSync) &&
                               !message.has_flag(Message::kFlagIsResponse);
   TRACE_EVENT_INSTANT("toplevel.flow", "Send mojo message",
diff --git a/mojo/public/cpp/bindings/struct_ptr.h b/mojo/public/cpp/bindings/struct_ptr.h
index 0310ac60945a..811bee1d11e3 100644
--- a/mojo/public/cpp/bindings/struct_ptr.h
+++ b/mojo/public/cpp/bindings/struct_ptr.h
@@ -14,7 +14,6 @@
 #include "base/template_util.h"
 #include "mojo/public/cpp/bindings/lib/hash_util.h"
 #include "mojo/public/cpp/bindings/type_converter.h"
-#include "third_party/perfetto/include/perfetto/tracing/traced_value_forward.h"
 
 namespace mojo {
 namespace internal {
diff --git a/mojo/public/cpp/bindings/tracing_helpers.h b/mojo/public/cpp/bindings/tracing_helpers.h
index fe29838d5b1f..622556725c37 100644
--- a/mojo/public/cpp/bindings/tracing_helpers.h
+++ b/mojo/public/cpp/bindings/tracing_helpers.h
@@ -5,7 +5,7 @@
 #ifndef MOJO_PUBLIC_CPP_BINDINGS_TRACING_HELPERS_H_
 #define MOJO_PUBLIC_CPP_BINDINGS_TRACING_HELPERS_H_
 
-#include "base/trace_event/trace_event.h"
+#include "base/trace_event/base_tracing.h"
 #include "build/buildflag.h"
 #include "mojo/public/cpp/bindings/mojo_buildflags.h"
 
diff --git a/mojo/public/cpp/system/simple_watcher.cc b/mojo/public/cpp/system/simple_watcher.cc
index a650681f7e9a..2b71d884096f 100644
--- a/mojo/public/cpp/system/simple_watcher.cc
+++ b/mojo/public/cpp/system/simple_watcher.cc
@@ -10,11 +10,12 @@
 #include "base/task/common/task_annotator.h"
 #include "base/task/sequenced_task_runner.h"
 #include "base/threading/thread_task_runner_handle.h"
-#include "base/trace_event/heap_profiler.h"
-#include "base/trace_event/trace_event.h"
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/c/system/trap.h"
+
+#if BUILDFLAG(ENABLE_BASE_TRACING)
 #include "third_party/perfetto/protos/perfetto/trace/track_event/chrome_mojo_event_info.pbzero.h"
+#endif
 
 namespace mojo {
 
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/module-shared.cc.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/module-shared.cc.tmpl
index 38234e83bd15..7b5e20a0c4a9 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/module-shared.cc.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/module-shared.cc.tmpl
@@ -10,10 +10,10 @@
 #include <utility>
 
 #include "base/strings/stringprintf.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/cpp/bindings/lib/validate_params.h"
 #include "mojo/public/cpp/bindings/lib/validation_errors.h"
 #include "mojo/public/cpp/bindings/lib/validation_util.h"
-#include "third_party/perfetto/include/perfetto/tracing/traced_value.h"
 
 #include "{{module.path}}-params-data.h"
 
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/module-shared.h.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/module-shared.h.tmpl
index 29aca2342983..99b31ae45c92 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/module-shared.h.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/module-shared.h.tmpl
@@ -52,7 +52,7 @@ namespace {{namespace}} {
 #include "mojo/public/cpp/bindings/string_data_view.h"
 {%- endif %}
 
-#include "third_party/perfetto/include/perfetto/tracing/traced_value_forward.h"
+#include "base/trace_event/base_tracing.h"
 
 #include "{{module.path}}-shared-internal.h"
 {%- for import in imports %}
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl
index ee5fa3492f22..44908a0e6383 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl
@@ -27,8 +27,7 @@
 #include "base/run_loop.h"
 #include "base/strings/string_number_conversions.h"
 #include "base/task/common/task_annotator.h"
-#include "base/trace_event/trace_event.h"
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/cpp/bindings/lib/generated_code_util.h"
 #include "mojo/public/cpp/bindings/lib/message_internal.h"
 #include "mojo/public/cpp/bindings/lib/send_message_helper.h"
@@ -39,7 +38,6 @@
 #include "mojo/public/cpp/bindings/lib/validation_errors.h"
 #include "mojo/public/cpp/bindings/mojo_buildflags.h"
 #include "mojo/public/interfaces/bindings/interface_control_messages.mojom.h"
-#include "third_party/perfetto/include/perfetto/tracing/traced_value.h"
 
 #include "{{module.path}}-params-data.h"
 #include "{{module.path}}-shared-message-ids.h"
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl
index 146c3e71da67..df52df21d2e2 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl
@@ -58,7 +58,7 @@ namespace {{variant}} {
 #include "mojo/public/cpp/bindings/union_traits.h"
 {%- endif %}
 
-#include "third_party/perfetto/include/perfetto/tracing/traced_value_forward.h"
+#include "base/trace_event/base_tracing.h"
 
 #include "{{module.path}}-shared.h"
 #include "{{variant_path}}-forward.h"
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/wrapper_class_definition.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/wrapper_class_definition.tmpl
index eba234eff900..3bfe4759ed8e 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/wrapper_class_definition.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/wrapper_class_definition.tmpl
@@ -34,7 +34,9 @@ size_t {{struct.name}}::Hash(size_t seed) const {
 
 void {{struct.name}}::WriteIntoTrace(
     perfetto::TracedValue traced_context) const {
+{%- if struct.fields %}
   auto dict = std::move(traced_context).WriteDictionary();
+{%- endif %}
 {%-  for field in struct.fields %}
   perfetto::WriteIntoTracedValueWithFallback(
     dict.AddItem(
-- 
2.35.0.rc0.227.g00780c9af4-goog

