From 19add18471b75399b9edcb93b399043b62d740c3 Mon Sep 17 00:00:00 2001
From: hscham <hscham@chromium.org>
Date: Thu, 21 Apr 2022 11:48:47 +0900
Subject: [PATCH 2/4] Include base_tracing.h instead of real headers in mojo

Change-Id: I346583111a0be26c5007d52d5cfff39fd60a76ff
---
 mojo/core/channel.cc                                       | 2 +-
 mojo/core/core.cc                                          | 2 +-
 mojo/core/data_pipe_consumer_dispatcher.cc                 | 2 +-
 mojo/core/data_pipe_producer_dispatcher.cc                 | 2 +-
 mojo/core/handle_table.cc                                  | 4 +++-
 mojo/core/handle_table.h                                   | 2 +-
 mojo/core/message_pipe_dispatcher.cc                       | 3 +--
 mojo/core/user_message_impl.cc                             | 5 +----
 .../memory_allocator_dump_cross_process_uid_mojom_traits.h | 2 +-
 mojo/public/cpp/bindings/lib/connector.cc                  | 6 +++---
 mojo/public/cpp/bindings/lib/interface_endpoint_client.cc  | 4 ++--
 mojo/public/cpp/bindings/lib/message.cc                    | 5 +----
 mojo/public/cpp/bindings/lib/send_message_helper.cc        | 4 +++-
 mojo/public/cpp/bindings/struct_ptr.h                      | 1 -
 mojo/public/cpp/bindings/tracing_helpers.h                 | 2 +-
 mojo/public/cpp/system/simple_watcher.cc                   | 7 ++++---
 .../generators/cpp_templates/module-shared.cc.tmpl         | 2 +-
 .../bindings/generators/cpp_templates/module-shared.h.tmpl | 2 +-
 .../tools/bindings/generators/cpp_templates/module.cc.tmpl | 4 +---
 .../tools/bindings/generators/cpp_templates/module.h.tmpl  | 2 +-
 .../generators/cpp_templates/wrapper_class_definition.tmpl | 2 ++
 21 files changed, 31 insertions(+), 34 deletions(-)

diff --git a/mojo/core/channel.cc b/mojo/core/channel.cc
index 821928362d..5f56c95cfa 100644
--- a/mojo/core/channel.cc
+++ b/mojo/core/channel.cc
@@ -17,7 +17,7 @@
 #include "base/memory/raw_ptr.h"
 #include "base/numerics/safe_math.h"
 #include "base/process/process_handle.h"
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 #include "build/build_config.h"
 #include "mojo/core/configuration.h"
 #include "mojo/core/core.h"
diff --git a/mojo/core/core.cc b/mojo/core/core.cc
index 8390a2d9a2..fe54be1940 100644
--- a/mojo/core/core.cc
+++ b/mojo/core/core.cc
@@ -21,7 +21,7 @@
 #include "base/strings/string_piece.h"
 #include "base/threading/thread_task_runner_handle.h"
 #include "base/time/time.h"
-#include "base/trace_event/memory_dump_manager.h"
+#include "base/trace_event/base_tracing.h"
 #include "build/build_config.h"
 #include "mojo/core/channel.h"
 #include "mojo/core/configuration.h"
diff --git a/mojo/core/data_pipe_consumer_dispatcher.cc b/mojo/core/data_pipe_consumer_dispatcher.cc
index 05b95c545f..7bdc640b42 100644
--- a/mojo/core/data_pipe_consumer_dispatcher.cc
+++ b/mojo/core/data_pipe_consumer_dispatcher.cc
@@ -15,7 +15,7 @@
 #include "base/logging.h"
 #include "base/memory/ref_counted.h"
 #include "base/numerics/checked_math.h"
-#include "base/trace_event/trace_event.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/core/core.h"
 #include "mojo/core/data_pipe_control_message.h"
 #include "mojo/core/node_controller.h"
diff --git a/mojo/core/data_pipe_producer_dispatcher.cc b/mojo/core/data_pipe_producer_dispatcher.cc
index f4281d9921..9c974e0d61 100644
--- a/mojo/core/data_pipe_producer_dispatcher.cc
+++ b/mojo/core/data_pipe_producer_dispatcher.cc
@@ -13,7 +13,7 @@
 #include "base/logging.h"
 #include "base/memory/ref_counted.h"
 #include "base/numerics/checked_math.h"
-#include "base/trace_event/trace_event.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/core/configuration.h"
 #include "mojo/core/core.h"
 #include "mojo/core/data_pipe_control_message.h"
diff --git a/mojo/core/handle_table.cc b/mojo/core/handle_table.cc
index 1befb91c64..7f4d55d903 100644
--- a/mojo/core/handle_table.cc
+++ b/mojo/core/handle_table.cc
@@ -7,8 +7,10 @@
 #include <stdint.h>
 
 #include <limits>
+#include <map>
 
-#include "base/trace_event/memory_dump_manager.h"
+#include "base/notreached.h"
+#include "base/trace_event/base_tracing.h"
 
 namespace mojo {
 namespace core {
diff --git a/mojo/core/handle_table.h b/mojo/core/handle_table.h
index 331008d637..6348f42152 100644
--- a/mojo/core/handle_table.h
+++ b/mojo/core/handle_table.h
@@ -12,7 +12,7 @@
 
 #include "base/gtest_prod_util.h"
 #include "base/synchronization/lock.h"
-#include "base/trace_event/memory_dump_provider.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/core/dispatcher.h"
 #include "mojo/core/system_impl_export.h"
 #include "mojo/public/c/system/types.h"
diff --git a/mojo/core/message_pipe_dispatcher.cc b/mojo/core/message_pipe_dispatcher.cc
index ad0a0bbf49..0a2404b602 100644
--- a/mojo/core/message_pipe_dispatcher.cc
+++ b/mojo/core/message_pipe_dispatcher.cc
@@ -9,8 +9,7 @@
 
 #include "base/logging.h"
 #include "base/memory/ref_counted.h"
-#include "base/trace_event/trace_event.h"
-#include "base/trace_event/trace_event_stub.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/core/core.h"
 #include "mojo/core/node_controller.h"
 #include "mojo/core/ports/event.h"
diff --git a/mojo/core/user_message_impl.cc b/mojo/core/user_message_impl.cc
index 09cb1be3f9..5b72cd0751 100644
--- a/mojo/core/user_message_impl.cc
+++ b/mojo/core/user_message_impl.cc
@@ -13,10 +13,7 @@
 #include "base/no_destructor.h"
 #include "base/numerics/safe_conversions.h"
 #include "base/numerics/safe_math.h"
-#include "base/trace_event/memory_allocator_dump.h"
-#include "base/trace_event/memory_dump_manager.h"
-#include "base/trace_event/memory_dump_provider.h"
-#include "base/trace_event/trace_event.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/core/configuration.h"
 #include "mojo/core/core.h"
 #include "mojo/core/node_channel.h"
diff --git a/mojo/public/cpp/base/memory_allocator_dump_cross_process_uid_mojom_traits.h b/mojo/public/cpp/base/memory_allocator_dump_cross_process_uid_mojom_traits.h
index e2ee25b22d..e1296e45fb 100644
--- a/mojo/public/cpp/base/memory_allocator_dump_cross_process_uid_mojom_traits.h
+++ b/mojo/public/cpp/base/memory_allocator_dump_cross_process_uid_mojom_traits.h
@@ -6,7 +6,7 @@
 #define MOJO_PUBLIC_CPP_BASE_MEMORY_ALLOCATOR_DUMP_CROSS_PROCESS_UID_MOJOM_TRAITS_H_
 
 #include "base/component_export.h"
-#include "base/trace_event/memory_allocator_dump_guid.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/mojom/base/memory_allocator_dump_cross_process_uid.mojom-shared.h"
 
 namespace mojo {
diff --git a/mojo/public/cpp/bindings/lib/connector.cc b/mojo/public/cpp/bindings/lib/connector.cc
index 4b8ebc99cc..bea6541338 100644
--- a/mojo/public/cpp/bindings/lib/connector.cc
+++ b/mojo/public/cpp/bindings/lib/connector.cc
@@ -23,9 +23,7 @@
 #include "base/synchronization/lock.h"
 #include "base/task/current_thread.h"
 #include "base/threading/sequence_local_storage_slot.h"
-#include "base/trace_event/trace_event.h"
-#include "base/trace_event/typed_macros.h"
-#include "base/trace_event/trace_event_stub.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/c/system/quota.h"
 #include "mojo/public/cpp/bindings/features.h"
 #include "mojo/public/cpp/bindings/lib/may_auto_lock.h"
@@ -34,7 +32,9 @@
 #include "mojo/public/cpp/bindings/sync_handle_watcher.h"
 #include "mojo/public/cpp/bindings/tracing_helpers.h"
 #include "mojo/public/cpp/system/wait.h"
+#if defined(ENABLE_BASE_TRACING)
 #include "third_party/perfetto/protos/perfetto/trace/track_event/chrome_mojo_event_info.pbzero.h"
+#endif
 
 #if defined(ENABLE_IPC_FUZZER)
 #include "mojo/public/cpp/bindings/message_dumper.h"
diff --git a/mojo/public/cpp/bindings/lib/interface_endpoint_client.cc b/mojo/public/cpp/bindings/lib/interface_endpoint_client.cc
index 6260a4cef4..6bd7e583f8 100644
--- a/mojo/public/cpp/bindings/lib/interface_endpoint_client.cc
+++ b/mojo/public/cpp/bindings/lib/interface_endpoint_client.cc
@@ -19,7 +19,7 @@
 #include "base/synchronization/waitable_event.h"
 #include "base/task/bind_post_task.h"
 #include "base/task/sequenced_task_runner.h"
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/cpp/bindings/associated_group.h"
 #include "mojo/public/cpp/bindings/associated_group_controller.h"
 #include "mojo/public/cpp/bindings/interface_endpoint_controller.h"
@@ -28,7 +28,7 @@
 #include "mojo/public/cpp/bindings/sync_call_restrictions.h"
 #include "mojo/public/cpp/bindings/sync_event_watcher.h"
 #include "mojo/public/cpp/bindings/thread_safe_proxy.h"
-#include "third_party/perfetto/protos/perfetto/trace/track_event/chrome_mojo_event_info.pbzero.h"
+// #include "third_party/perfetto/protos/perfetto/trace/track_event/chrome_mojo_event_info.pbzero.h"
 
 namespace mojo {
 
diff --git a/mojo/public/cpp/bindings/lib/message.cc b/mojo/public/cpp/bindings/lib/message.cc
index 51a7c5763e..bb89e340f0 100644
--- a/mojo/public/cpp/bindings/lib/message.cc
+++ b/mojo/public/cpp/bindings/lib/message.cc
@@ -19,10 +19,7 @@
 #include "base/memory/ptr_util.h"
 #include "base/numerics/safe_math.h"
 #include "base/threading/sequence_local_storage_slot.h"
-#include "base/trace_event/trace_event.h"
-#include "base/trace_event/trace_event_stub.h"
-#include "base/trace_event/trace_id_helper.h"
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/cpp/bindings/associated_group_controller.h"
 #include "mojo/public/cpp/bindings/lib/array_internal.h"
 #include "mojo/public/cpp/bindings/lib/message_fragment.h"
diff --git a/mojo/public/cpp/bindings/lib/send_message_helper.cc b/mojo/public/cpp/bindings/lib/send_message_helper.cc
index 13e1be40e5..503f8d3466 100644
--- a/mojo/public/cpp/bindings/lib/send_message_helper.cc
+++ b/mojo/public/cpp/bindings/lib/send_message_helper.cc
@@ -7,13 +7,14 @@
 #include <cstring>
 #include <tuple>
 
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 
 namespace mojo {
 namespace internal {
 
 void SendMessage(MessageReceiver& receiver, Message& message) {
   uint64_t flow_id = message.GetTraceId();
+  std::ignore = flow_id;
   bool is_sync_non_response = message.has_flag(Message::kFlagIsSync) &&
                               !message.has_flag(Message::kFlagIsResponse);
   TRACE_EVENT_INSTANT("toplevel.flow", "Send mojo message",
@@ -33,6 +34,7 @@ void SendMessage(MessageReceiverWithResponder& receiver,
                  Message& message,
                  std::unique_ptr<MessageReceiver> responder) {
   uint64_t flow_id = message.GetTraceId();
+  std::ignore = flow_id;
   bool is_sync_non_response = message.has_flag(Message::kFlagIsSync) &&
                               !message.has_flag(Message::kFlagIsResponse);
   TRACE_EVENT_INSTANT("toplevel.flow", "Send mojo message",
diff --git a/mojo/public/cpp/bindings/struct_ptr.h b/mojo/public/cpp/bindings/struct_ptr.h
index 0310ac6094..811bee1d11 100644
--- a/mojo/public/cpp/bindings/struct_ptr.h
+++ b/mojo/public/cpp/bindings/struct_ptr.h
@@ -14,7 +14,6 @@
 #include "base/template_util.h"
 #include "mojo/public/cpp/bindings/lib/hash_util.h"
 #include "mojo/public/cpp/bindings/type_converter.h"
-#include "third_party/perfetto/include/perfetto/tracing/traced_value_forward.h"
 
 namespace mojo {
 namespace internal {
diff --git a/mojo/public/cpp/bindings/tracing_helpers.h b/mojo/public/cpp/bindings/tracing_helpers.h
index 23644d5f25..3e6a6afb75 100644
--- a/mojo/public/cpp/bindings/tracing_helpers.h
+++ b/mojo/public/cpp/bindings/tracing_helpers.h
@@ -5,7 +5,7 @@
 #ifndef MOJO_PUBLIC_CPP_BINDINGS_TRACING_HELPERS_H_
 #define MOJO_PUBLIC_CPP_BINDINGS_TRACING_HELPERS_H_
 
-#include "base/trace_event/trace_event.h"
+#include "base/trace_event/base_tracing.h"
 #include "build/buildflag.h"
 #include "mojo/public/cpp/bindings/message.h"
 #include "mojo/public/cpp/bindings/mojo_buildflags.h"
diff --git a/mojo/public/cpp/system/simple_watcher.cc b/mojo/public/cpp/system/simple_watcher.cc
index a650681f7e..2b71d88409 100644
--- a/mojo/public/cpp/system/simple_watcher.cc
+++ b/mojo/public/cpp/system/simple_watcher.cc
@@ -10,11 +10,12 @@
 #include "base/task/common/task_annotator.h"
 #include "base/task/sequenced_task_runner.h"
 #include "base/threading/thread_task_runner_handle.h"
-#include "base/trace_event/heap_profiler.h"
-#include "base/trace_event/trace_event.h"
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/c/system/trap.h"
+
+#if BUILDFLAG(ENABLE_BASE_TRACING)
 #include "third_party/perfetto/protos/perfetto/trace/track_event/chrome_mojo_event_info.pbzero.h"
+#endif
 
 namespace mojo {
 
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/module-shared.cc.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/module-shared.cc.tmpl
index 38234e83bd..7b5e20a0c4 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/module-shared.cc.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/module-shared.cc.tmpl
@@ -10,10 +10,10 @@
 #include <utility>
 
 #include "base/strings/stringprintf.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/cpp/bindings/lib/validate_params.h"
 #include "mojo/public/cpp/bindings/lib/validation_errors.h"
 #include "mojo/public/cpp/bindings/lib/validation_util.h"
-#include "third_party/perfetto/include/perfetto/tracing/traced_value.h"
 
 #include "{{module.path}}-params-data.h"
 
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/module-shared.h.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/module-shared.h.tmpl
index 29aca23429..99b31ae45c 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/module-shared.h.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/module-shared.h.tmpl
@@ -52,7 +52,7 @@ namespace {{namespace}} {
 #include "mojo/public/cpp/bindings/string_data_view.h"
 {%- endif %}
 
-#include "third_party/perfetto/include/perfetto/tracing/traced_value_forward.h"
+#include "base/trace_event/base_tracing.h"
 
 #include "{{module.path}}-shared-internal.h"
 {%- for import in imports %}
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl
index 87077f1463..e1dc19f0ed 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl
@@ -26,8 +26,7 @@
 #include "base/hash/md5_constexpr.h"
 #include "base/run_loop.h"
 #include "base/strings/string_number_conversions.h"
-#include "base/trace_event/trace_event.h"
-#include "base/trace_event/typed_macros.h"
+#include "base/trace_event/base_tracing.h"
 #include "mojo/public/cpp/bindings/lib/generated_code_util.h"
 #include "mojo/public/cpp/bindings/lib/message_internal.h"
 #include "mojo/public/cpp/bindings/lib/send_message_helper.h"
@@ -39,7 +38,6 @@
 #include "mojo/public/cpp/bindings/lib/validation_errors.h"
 #include "mojo/public/cpp/bindings/mojo_buildflags.h"
 #include "mojo/public/interfaces/bindings/interface_control_messages.mojom.h"
-#include "third_party/perfetto/include/perfetto/tracing/traced_value.h"
 
 #include "{{module.path}}-params-data.h"
 #include "{{module.path}}-shared-message-ids.h"
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl
index b1ae8b063d..4f7d090fde 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl
@@ -58,7 +58,7 @@ namespace {{variant}} {
 #include "mojo/public/cpp/bindings/union_traits.h"
 {%- endif %}
 
-#include "third_party/perfetto/include/perfetto/tracing/traced_value_forward.h"
+#include "base/trace_event/base_tracing.h"
 
 #include "{{module.path}}-shared.h"
 #include "{{variant_path}}-forward.h"
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/wrapper_class_definition.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/wrapper_class_definition.tmpl
index eba234eff9..3bfe4759ed 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/wrapper_class_definition.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/wrapper_class_definition.tmpl
@@ -34,7 +34,9 @@ size_t {{struct.name}}::Hash(size_t seed) const {
 
 void {{struct.name}}::WriteIntoTrace(
     perfetto::TracedValue traced_context) const {
+{%- if struct.fields %}
   auto dict = std::move(traced_context).WriteDictionary();
+{%- endif %}
 {%-  for field in struct.fields %}
   perfetto::WriteIntoTracedValueWithFallback(
     dict.AddItem(
-- 
2.36.0.rc2.479.g8af0fa9b8e-goog

