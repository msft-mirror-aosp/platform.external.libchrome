From 8d4dfa3be4377afda6b303f2c1e5522ef85c6e6f Mon Sep 17 00:00:00 2001
From: Grace Cham <hscham@chromium.org>
Date: Thu, 12 May 2022 14:19:35 +0900
Subject: [PATCH] Revert "tmp"

This reverts commit e0fcc37399dc471323e175b100a0006efffaf801.
---
 base/allocator/allocator_shim_override_cpp_symbols.h  | 4 ++++
 base/allocator/allocator_shim_override_libc_symbols.h | 4 ++++
 2 files changed, 8 insertions(+)

diff --git a/base/allocator/allocator_shim_override_cpp_symbols.h b/base/allocator/allocator_shim_override_cpp_symbols.h
index 5649e906fb..83060bcd6d 100644
--- a/base/allocator/allocator_shim_override_cpp_symbols.h
+++ b/base/allocator/allocator_shim_override_cpp_symbols.h
@@ -66,6 +66,9 @@
 #define SHIM_CPP_SYMBOLS_EXPORT NOINLINE
 #endif
 
+// Disable custom memory allocator when asan is used.
+// https://crbug.com/807685
+#if !defined(DISABLE_ALLOCATOR_SANITIZER)
 SHIM_CPP_SYMBOLS_EXPORT void* operator new(size_t size) {
   return ShimCppNew(size);
 }
@@ -164,3 +167,4 @@ ALIGN_LINKAGE SHIM_CPP_SYMBOLS_EXPORT void
 ALIGN_DEL_ARR_NOTHROW(void* p, ALIGN_VAL_T, const std::nothrow_t&) __THROW {
   ShimCppDelete(p);
 }
+#endif
diff --git a/base/allocator/allocator_shim_override_libc_symbols.h b/base/allocator/allocator_shim_override_libc_symbols.h
index 3738dd9e87..cc66014977 100644
--- a/base/allocator/allocator_shim_override_libc_symbols.h
+++ b/base/allocator/allocator_shim_override_libc_symbols.h
@@ -20,6 +20,9 @@
 
 #include "base/allocator/allocator_shim_internals.h"
 
+// Disable custom memory allocator when asan is used.
+// https://crbug.com/807685
+#if !defined(DISABLE_ALLOCATOR_SANITIZER)
 extern "C" {
 
 SHIM_ALWAYS_EXPORT void* malloc(size_t size) __THROW {
@@ -77,3 +80,4 @@ SHIM_ALWAYS_EXPORT size_t malloc_usable_size(void* address) __THROW {
 //   struct mallinfo mallinfo(void);
 
 }  // extern "C"
+#endif
-- 
2.36.0.512.ge40c2bad7a-goog

