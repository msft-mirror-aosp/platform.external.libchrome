From b566ffb3ea3d2f9bcb83868eacb32ecd4c2f4c0c Mon Sep 17 00:00:00 2001
From: hscham <hscham@chromium.org>
Date: Thu, 28 Oct 2021 10:51:29 +0900
Subject: [PATCH] Add base::AdaptCallbackForRepeating

TODO(b/204383858): remove usage of base::AdaptCallbackForRepeating in
media_perception.

Change-Id: I9fd2f789c6c31dacbb901d28c0d20a984b2e9162
---
 base/functional/callback_helpers.h | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/base/functional/callback_helpers.h b/base/functional/callback_helpers.h
index 417610f6dcd3..a1df1373277e 100644
--- a/base/functional/callback_helpers.h
+++ b/base/functional/callback_helpers.h
@@ -96,6 +96,22 @@ class OnceCallbackHolder final {
 
 }  // namespace internal
 
+// Wraps the given OnceCallback into a RepeatingCallback that relays its
+// invocation to the original OnceCallback on the first invocation. The
+// following invocations are just ignored.
+//
+// Note that this deliberately subverts the Once/Repeating paradigm of Callbacks
+// but helps ease the migration from old-style Callbacks. Avoid if possible; use
+// if necessary for migration. TODO(tzik): Remove it. https://crbug.com/730593
+template <typename... Args>
+RepeatingCallback<void(Args...)> AdaptCallbackForRepeating(
+    OnceCallback<void(Args...)> callback) {
+  using Helper = internal::OnceCallbackHolder<Args...>;
+  return base::BindRepeating(
+      &Helper::Run, std::make_unique<Helper>(std::move(callback),
+                                             /*ignore_extra_runs=*/true));
+}
+
 // Wraps the given OnceCallback and returns two OnceCallbacks with an identical
 // signature. On first invokation of either returned callbacks, the original
 // callback is invoked. Invoking the remaining callback results in a crash.
-- 
2.38.0.135.g90850a2211-goog

