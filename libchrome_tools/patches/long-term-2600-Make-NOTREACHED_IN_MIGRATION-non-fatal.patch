From 19e0c1c5713e9eb7116d591da24ceb2de0045dcf Mon Sep 17 00:00:00 2001
From: Ryo Hashimoto <hashimoto@chromium.org>
Date: Tue, 17 Sep 2024 16:25:53 +0900
Subject: [PATCH] Make NOTREACHED_IN_MIGRATION non-fatal

BUG=b:367556630
TEST=CQ

Change-Id: I3eebfc618a0b05bd0b20225a1c53e602ad443789
---
 base/check.cc | 13 ++++++-------
 1 file changed, 6 insertions(+), 7 deletions(-)

diff --git a/base/check.cc b/base/check.cc
index bd63d5a88e..6a15acb852 100644
--- a/base/check.cc
+++ b/base/check.cc
@@ -30,13 +30,12 @@ namespace logging {
 namespace {
 
 LogSeverity GetDumpSeverity() {
-#if defined(OFFICIAL_BUILD)
-  return DCHECK_IS_ON() ? LOGGING_DCHECK : LOGGING_ERROR;
-#else
-  // Crash outside official builds (outside user-facing builds) to detect
-  // invariant violations early in release-build testing like fuzzing, etc.
-  // These should eventually be migrated to fatal CHECKs.
+#if BUILDFLAG(USE_FUZZING_ENGINE)
+  // Crash in fuzzing builds because non-fatal CHECKs will eventually be
+  // migrated to fatal CHECKs.
   return LOGGING_FATAL;
+#else
+  return DCHECK_IS_ON() ? LOGGING_DCHECK : LOGGING_ERROR;
 #endif
 }
 
@@ -347,7 +346,7 @@ CheckError::CheckError(LogMessage* log_message) : log_message_(log_message) {}
 NotReachedError NotReachedError::NotReached(base::NotFatalUntil fatal_milestone,
                                             const base::Location& location) {
   auto* const log_message = new NotReachedLogMessage(
-      location, GetCheckSeverity(fatal_milestone), fatal_milestone);
+      location, GetNotFatalUntilSeverity(fatal_milestone), fatal_milestone);
 
   // TODO(pbos): Consider a better message for NotReached(), this is here to
   // match existing behavior + test expectations.
-- 
2.46.0.662.g92d0881bb0-goog

